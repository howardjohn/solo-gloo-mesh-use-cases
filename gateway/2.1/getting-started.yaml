###########################################################################################
# This is an example Helm values file for quickstart installations.                       #
# To see the default settings, run                                                        #
# helm show values gloo-mesh-enterprise/gloo-mesh-enterprise --version $GLOO_MESH_VERSION #
###########################################################################################

# Global settings for management plane configuration
# Namespace to install Gloo Platform components
adminNamespace: gloo-mesh
# Name of the management cluster
global:
  cluster: $CLUSTER_NAME
# Name of the management cluster
mgmtClusterName: $CLUSTER_NAME
# Set the logger to development mode, which can cause panics. Do not use in production.
devMode: false
# Set to true to permit unencrypted and unauthenticated communication between management plane and data planes. Do not use in production.
insecure: false
# Enable leader election for the HA deployment
leaderElection: true

# For each Gloo product that you want to install, provide the license keys that you got from your Solo account representative
# Provide your $GLOO_MESH_LICENSE_KEY to install Gloo Mesh Enterprise
glooMeshLicenseKey: ""
# Provide your $GLOO_GATEWAY_LICENSE_KEY to install Gloo Mesh Gateway
glooGatewayLicenseKey: ""
# Provide your $GLOO_NETWORK_LICENSE_KEY to install Gloo Network
glooNetworkLicenseKey: ""
# To provide license keys in a secret in the cluster instead, specify the secret name
licenseSecretName: ""

# Settings for the default Prometheus server
prometheus:
  alertmanager:
    enabled: false
  enabled: true
  kubeStateMetrics:
    enabled: false
  nodeExporter:
    enabled: false
  podSecurityPolicy:
    enabled: false
  pushgateway:
    enabled: false
  rbac:
    create: true
  server:
    fullnameOverride: prometheus-server
    persistentVolume:
      enabled: false
  serverFiles:
    prometheus.yml:
      scrape_configs:
      - job_name: gloo-mesh-pods
        kubernetes_sd_configs:
        - namespaces:
            names:
            - gloo-mesh
          role: pod
        relabel_configs:
        - action: keep
          regex: true
          source_labels:
          - __meta_kubernetes_pod_annotation_prometheus_io_scrape
        - action: replace
          regex: (.+)
          source_labels:
          - __meta_kubernetes_pod_annotation_prometheus_io_path
          target_label: __metrics_path__
        - action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          source_labels:
          - __address__
          - __meta_kubernetes_pod_annotation_prometheus_io_port
          target_label: __address__
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - action: replace
          source_labels:
          - __meta_kubernetes_namespace
          target_label: namespace
        - action: replace
          source_labels:
          - __meta_kubernetes_pod_name
          target_label: pod
        - action: keep
          regex: gloo-mesh-mgmt-server
          source_labels:
          - __meta_kubernetes_pod_label_app
        scrape_interval: 15s
        scrape_timeout: 10s
  serviceAccounts:
    alertmanager:
      create: false
    nodeExporter:
      create: false
    pushgateway:
      create: false
    server:
      create: true
# Default Prometheus server address
prometheusUrl: http://prometheus-server
verbose: false

# Configuration for the gloo-mesh-mgmt-server deployment
glooMeshMgmtServer:
  enabled: true
  env:
  - name: POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: LICENSE_KEY
    valueFrom:
      secretKeyRef:
        key: key
        name: gloo-mesh-enterprise-license
        optional: true
  # Required for OpenShift installations: Allow the pod to be assigned a dynamic user ID.
  floatingUserId: false
  image:
    pullPolicy: IfNotPresent
    registry: gcr.io/gloo-mesh
    repository: gloo-mesh-mgmt-server
    # Gloo Mesh Enterprise patch version. For a list of patch versions,
    # see https://docs.solo.io/gloo-mesh-enterprise/main/reference/changelog/
    tag: $GLOO_MESH_VERSION
  ports:
    # gloo-mesh-mgmt-server service port for Gloo agents to connect to
    grpc: 9900
    healthcheck: 8090
    # Port on which to serve internal Prometheus metrics for the management server app
    stats: 9091
  # Static user ID to run the containers as. Unused if floatingUserId is 'true'
  runAsUser: 10101
  # Kubernetes load balancer service type
  serviceType: LoadBalancer
  # Optional configuration for the deployed containers
  sidecars: {}
  # Concurrency to use for translation operations
  concurrency: 10
  # Maximum message size for gRPC messages sent and received by the management server
  maxGrpcMessageSize: "4294967295"
  # Configuration for certificates to secure server-agent relay communication
  relay:
    # Disable default relay CA functionality only when supplying custom client certs to the agents for relay mTLS
    disableCa: false
    disableCaCertGeneration: false
    disableTokenGeneration: false
    # Push RBAC resources to the management server. Required for multicluster RBAC in the UI
    pushRbac: true
    signingTlsSecret:
      name: relay-tls-signing-secret
    # Reference to the generated secret containing default TLS certificates used to secure the networking gRPC server with TLS
    tlsSecret:
      name: relay-server-tls-secret
    # Reference to the generated secret containing a shared token for authenticating relay agents when they first communicate with the management plane
    tokenSecret:
      key: token
      name: relay-identity-token-secret
      namespace: ""

# Configuration for the Gloo UI
glooMeshUi:
  enabled: true
  env:
  - name: POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: LICENSE_KEY
    valueFrom:
      secretKeyRef:
        key: key
        name: gloo-mesh-enterprise-license
        optional: true
  # Required for OpenShift installations: Allow the pod to be assigned a dynamic user ID.
  floatingUserId: false
  image:
    pullPolicy: IfNotPresent
    registry: gcr.io/gloo-mesh
    repository: gloo-mesh-apiserver
    # Gloo Mesh Enterprise patch version
    tag: $GLOO_MESH_VERSION
  # Ports for UI service
  ports:
    console: 8090
    grpc: 10101
    healthcheck: 8081
  # UI pod resources
  resources:
    requests:
      cpu: 125m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Gi
  # Static user ID to run the containers as. Unused if floatingUserId is 'true'
  runAsUser: 10101
  # Kubernetes service type
  serviceType: ClusterIP
  # Configuration for the console and envoy containers
  sidecars:
    console:
      env: null
      image:
        pullPolicy: IfNotPresent
        registry: gcr.io/gloo-mesh
        repository: gloo-mesh-ui
        # Gloo Mesh Enterprise patch version
        tag: $GLOO_MESH_VERSION
      resources:
        requests:
          cpu: 125m
          memory: 256Mi
    envoy:
      env:
      - name: ENVOY_UID
        value: "0"
      image:
        pullPolicy: IfNotPresent
        registry: gcr.io/gloo-mesh
        repository: gloo-mesh-envoy
        # Gloo Mesh Enterprise patch version
        tag: $GLOO_MESH_VERSION
  # To use the license keys in your provided secret instead of referencing the
  # secret generated by this Helm chart, specify the secret name.
  licenseSecretName: ""
  # Name of the dashboard settings object to use
  settingsName: settings

# Configuration for an optional Redis instance to store ID tokens for UI auth
glooMeshRedis:
  enabled: true
  env:
  - name: MASTER
    value: "true"
  # Required for OpenShift installations: Allow the pod to be assigned a dynamic user ID.
  floatingUserId: false
  image:
    pullPolicy: IfNotPresent
    registry: docker.io
    repository: redis
    tag: 6.2.6
  ports:
    redis: 6379
  resources:
    requests:
      cpu: 125m
      memory: 256Mi
  # Static user ID to run the containers as. Unused if floatingUserId is 'true'
  runAsUser: 10101
  serviceType: ClusterIP
  sidecars: {}
  addr: ""

# Install the Gloo agent alongside the management server,
# such as to run the management cluster also as a workload cluster in a single-cluster setup.
registerMgmtPlane:
  # Number of access logs to buffer per Envoy proxy
  accessLogsBufferSize: 50
  # Name of the workload cluster by which cluster is referenced in all Gloo configurations
  cluster: $REMOTE_CLUSTER
  # Set the logger to development mode, which can cause panics. Do not use in production.
  devMode: false
  # Install the Gloo agent alongside the management server
  enabled: true
  # Install external authentication service in the gloo-mesh namespace.
  ext-auth-service:
    enabled: true
    extraTemplateAnnotations:
      proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
  # Install the Gloo Network-specific agent functionality only if you installed Gloo Network.
  gloo-network-agent:
    enabled: false
  # Set to true to permit unencrypted and unauthenticated communication between management plane and data planes. Do not use in production.
  insecure: false
  # Configuration for the istiod sidecar deployment
  istiodSidecar:
    # Create the cluster role binding needed by the istiod sidecar
    createRoleBinding: false
    # Object reference to istiod service account
    istiodServiceAccount:
      name: istiod
      namespace: istio-system
  # Enable leader election for the HA deployment
  leaderElection: true
  # Configuration for managed Istio control plane and gateway installations by using the Istio Lifecycle Manager
  managedInstallations:
    cluster: $REMOTE_CLUSTER
    # Solo.io Istio distribution repository; required for Gloo Mesh Istio. You get the repo key from your Solo Account Representative.
    hub: $REPO
    # Any Solo.io Gloo Mesh Istio tag
    tag: $ISTIO_IMAGE
    # Deploy the istiod control plane
    controlPlane:
      enabled: true
      overrides: {}
    # Deploy an Istio east-west gateway
    eastWestGateways:
    - enabled: true
      name: istio-eastwestgateway
      overrides: {}
    # Deploy an Istio ingress gateway
    northSouthGateways:
    - enabled: true
      name: istio-ingressgateway
      overrides: {}
  # Maximum message size for gRPC messages sent and received by the management server
  maxGrpcMessageSize: "4294967295"
  # Number of metrics messages to buffer per Envoy proxy
  metricsBufferSize: 50
  # Install rate limiting service in the gloo-mesh namespace.
  rate-limiter:
    enabled: true
    extraTemplateAnnotations:
      proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
  relay:
    # SNI name used to connect to relay forwarding server. Must match server certificate CommonName (DO NOT CHANGE)
    authority: gloo-mesh-mgmt-server.gloo-mesh
    # Reference to a secret containing TLS certs used to secure the networking gRPC server with TLS.
    clientTlsSecret:
      name: relay-client-tls-secret
    # Reference to a secret containing a root TLS cert used to verify the relay server cert. 
    # The secret can also optionally specify a 'tls.key' which will be used to generate the agent client cert.
    rootTlsSecret:
      name: relay-root-tls-secret
    # Address and port by which gloo-mesh-mgmt-server in the Gloo management plane is accessed
    serverAddress: $MGMT_SERVER_NETWORKING_ADDRESS
    # Default self-signed certs: Reference to a secret containing a shared token for authenticating to the relay server
    tokenSecret:
      key: token
      name: relay-identity-token-secret
      namespace: gloo-mesh
  # Enable eBPF sidecar acceleration to reduce network latency in your service mesh. Do not use in production.
  sidecar-accel:
    enabled: false
  # Enable verbose/debug logging
  verbose: false