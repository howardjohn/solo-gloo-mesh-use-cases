apiVersion: admin.gloo.solo.io/v2
kind: IstioLifecycleManager
metadata:
  name: managed-installation
  namespace: gloo-mesh
spec:
  clusters:
    - name: $REMOTE_CLUSTER1
    - name: $REMOTE_CLUSTER2
  installations:

    # OPERATOR SPEC FOR THE ISTIOD CONTROL PLANE
    - name: control-plane
      istioOperatorSpec:
        # Only the control plane components are installed (https://istio.io/latest/docs/setup/additional-setup/config-profiles/)
        profile: minimal
        # Solo.io Istio distribution repository; required for Gloo Mesh Istio. You get the repo key from your Solo Account Representative.
        hub: $REPO
        # Any Solo.io Gloo Mesh Istio tag
        tag: $ISTIO_IMAGE
        # Mesh configuration
        meshConfig:
          # Enable access logging only if using.
          accessLogFile: /dev/stdout
          # Encoding for the proxy access log (TEXT or JSON). Default value is TEXT.
          accessLogEncoding: JSON
          # Enable span tracing only if using.
          enableTracing: true
          defaultConfig:
            # Wait for the istio-proxy to start before starting application pods
            holdApplicationUntilProxyStarts: true
            # Enable Gloo Mesh metrics service. Required for Gloo Mesh UI
            envoyMetricsService:
              address: gloo-mesh-agent.gloo-mesh:9977
            # Enable Gloo Mesh accesslog service. Required for Gloo Mesh Access Logging
            envoyAccessLogService:
              address: gloo-mesh-agent.gloo-mesh:9977
            proxyMetadata:
              # Enable Istio agent to handle DNS requests for known hosts
              # Unknown hosts are automatically resolved using upstream DNS servers in resolv.conf (for proxy-dns)
              ISTIO_META_DNS_CAPTURE: "true"
              # Enable automatic address allocation (for proxy-dns)
              ISTIO_META_DNS_AUTO_ALLOCATE: "true"
          # Set the default behavior of the sidecar for handling outbound traffic from the application
          outboundTrafficPolicy:
            mode: ALLOW_ANY
        # Traffic management
        components:
          pilot:
            k8s:
              env:
                # Disable selecting workload entries for local service routing.
                # Required for Gloo Mesh VirtualDestinaton functionality.
                - name: PILOT_ENABLE_K8S_SELECT_WORKLOAD_ENTRIES
                  value: "false"
          # Disable gateways deployments, which are deployed in separate IstioOperator configurations
          ingressGateways:
          - name: istio-ingressgateway
            enabled: false
          - name: istio-eastwestgateway
            enabled: false
          egressGateways:
          - name: istio-egressgateway
            enabled: false

    # OPERATOR SPEC FOR THE INGRESS GATEWAY
    - name: ingress-gateway
      istioOperatorSpec:
        # No control plane components are installed
        profile: empty
        # Solo.io Istio distribution repository; required for Gloo Mesh Istio. You get the repo key from your Solo Account Representative.
        hub: $REPO
        # The Solo.io Gloo Mesh Istio tag
        tag: $ISTIO_IMAGE
        components:
          ingressGateways:
          # Enable the default ingress gateway
            - name: istio-ingressgateway
              # Deployed to istio-gateways by default
              namespace: istio-gateways
              enabled: true
              label:
                # Set a unique label for the gateway. This is required to ensure Gateways
                # can select this workload
                istio: ingressgateway
                app: istio-ingressgateway
              k8s:
                service:
                  type: LoadBalancer
                  selector:
                    istio: ingressgateway
                  # Default ports
                  ports:
                    # Port for health checks on path /healthz/ready. For AWS ELBs, this port must be listed first.
                    - name: status-port
                      port: 15021
                      targetPort: 15021
                    # Main HTTP ingress port
                    - port: 80
                      targetPort: 8080
                      name: http2
                    # Main HTTPS ingress port
                    - port: 443
                      targetPort: 8443
                      name: https
        # Helm values overrides
        values:
          gateways:
            istio-ingressgateway:
              # Enable gateway injection
              injectionTemplate: gateway

    # OPTIONAL: OPERATOR SPEC FOR THE EAST-WEST GATEWAY
    - name: eastwest-gateway
      istioOperatorSpec:
        # No control plane components are installed
        profile: empty
        # Solo.io Istio distribution repository; required for Gloo Mesh Istio. You get the repo key from your Solo Account Representative.
        hub: $REPO
        # The Solo.io Gloo Mesh Istio version
        tag: $ISTIO_IMAGE
        components:
          ingressGateways:
          # Enable the default east-west gateway
            - name: istio-eastwestgateway
              # Deployed to istio-gateways by default
              namespace: istio-gateways
              enabled: true
              label:
                # Set a unique label for the gateway. This is required to ensure Gateways
                # can select this workload.
                istio: eastwestgateway
                app: istio-eastwestgateway
              k8s:
                env:
                  # sni-dnat adds the clusters required for AUTO_PASSTHROUGH mode
                  # Required by Gloo Mesh for east/west routing
                  - name: ISTIO_META_ROUTER_MODE
                    value: "sni-dnat"
                service:
                  type: LoadBalancer
                  selector:
                    istio: eastwestgateway
                  # Default ports
                  ports:
                    # Port for health checks on path /healthz/ready. For AWS ELBs, this port must be listed first.
                    - port: 15021
                      targetPort: 15021
                      name: status-port
                    # Port for multicluster mTLS passthrough; required for Gloo Mesh east/west routing
                    - port: 15443
                      targetPort: 15443
                      # Gloo Mesh looks for this default name 'tls' on a gateway
                      name: tls
        # Helm values overrides
        values:
          gateways:
            istio-ingressgateway:
              # Enable gateway injection
              injectionTemplate: gateway